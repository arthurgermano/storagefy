import _ from"./IndexedDBAdapter.JOio7YFv.js";import E from"./LocalStorageAdapter.DbWFQp1Z.js";import v from"./SessionStorageAdapter.CH8sEP9e.js";import{S as w,R as b}from"./ReactAdapter.DGmXLvKE.js";import{j as S}from"./assign.MzTrJBn8.js";import{l as o,a as g}from"./StorageAdapter.-Hf96jOd.js";class y extends w{constructor(e){if(super(),!e)throw o("Adapter provided is not defined"),new Error("Adapter provided is not defined");this.adapter=e}_checkStore(e){if(!e||!e.$subscribe||!e.$patch)throw o("Store provided is not defined"),new Error("Store provided is not defined")}_registerOnDataChanged(e){g("PiniaAdapter - Registering onDataChanged listener"),e&&this.adapter.onDataChanged(async r=>{if(r.adapterId==this.adapter.adapterId||!r.origin)return;let t;r.value?t=await this.adapter._decrypt(r.key,r.value):t=await this.adapter.get(r.key),JSON.stringify(e.$state)!==JSON.stringify(t)&&(e.$state={...e.$state,...t,STORAGEFY_SILENT_CHANNEL_UPDATE:!0})})}async setInStorage(e,r,t={}){try{return g("PiniaAdapter - setInStorage - key:",r),this._checkStore(e),t.ignoreKeys=t.ignoreKeys||[],this._unsubscribe&&this._unsubscribe(),new Promise((n,s)=>{this._unsubscribe=e.$subscribe(async(d,u)=>{try{if(!u)return n(!0);if(u.STORAGEFY_SILENT_CHANNEL_UPDATE)return delete u.STORAGEFY_SILENT_CHANNEL_UPDATE,n(!0);const a={...u};for(let f in a)t.ignoreKeys.includes(f)&&(a[f]=void 0);return await this.adapter.set(r,a,t.timeout),n(!0)}catch(a){return s(a)}}),e.$patch({...e.$state}),t.syncTabs&&this._registerOnDataChanged(e)})}catch(n){throw o(n),n}}async getFromStorage(e,r){try{g("PiniaAdapter - getFromStorage - key:",r),this._checkStore(e);const t=await this.adapter.get(r);return t?(e.$patch(S({},t)),!0):void 0}catch(t){throw o(t),t}}}class A extends w{constructor(e){if(super(),!e)throw o("Adapter provided is not defined"),new Error("Adapter provided is not defined");this.adapter=e,this._unsubscribe=null}_registerOnDataChanged(e){g("SvelteAdapter - Registering onDataChanged listener"),e&&this.adapter.onDataChanged(async r=>{if(r.adapterId==this.adapter.adapterId||!r.origin)return;let t;e.subscribe(d=>{t=S({},d)})();let s;r.value?s=await this.adapter._decrypt(r.key,r.value):s=await this.adapter.get(r.key),JSON.stringify(t)!==JSON.stringify(s)&&(console.log("OK"),e.update(d=>({...d,...s,STORAGEFY_SILENT_CHANNEL_UPDATE:!0})))})}async setInStorage(e,r,t={}){try{return g("SvelteAdapter - setInStorage - key:",r),this._checkStore(e),t.ignoreKeys=t.ignoreKeys||[],this._unsubscribe&&this._unsubscribe(),new Promise((n,s)=>{const d=e.subscribe(async u=>{try{if(!u)return n(!0);const a={...u};for(let f in a)t.ignoreKeys.includes(f)&&(a[f]=void 0);return await this.adapter.set(r,a,t.timeout),n(!0)}catch(a){return s(a)}});this._unsubscribe=d,t.syncTabs&&this._registerOnDataChanged(e)})}catch(n){throw o(n),n}}async getFromStorage(e,r){try{g("SvelteAdapter - getFromStorage - key:",r),this._checkStore(e);const t=await this.adapter.get(r);return t?(e.set(S({},t)),!0):void 0}catch(t){throw o(t),t}}_checkStore(e){if(!e||typeof e.subscribe!="function"||typeof e.set!="function")throw o("Store provided is not a valid Svelte writable store"),new Error("Store provided is not a valid Svelte writable store")}}let c,h,p;function l({adapter:i,adapterParams:e,forceRecreate:r},t,n){if(i)return new n(i);if(t&&!r)return t;if(e){const s=m(e);return new n(s)}throw new Error("Storage adapter not initialized. Call startStoragefy first.")}function m(i){switch(i.adapter){case"localStorage":return new E(i);case"sessionStorage":return new v(i);default:return new _(i)}}function k({adapter:i=null,adapterParams:e=null,forceRecreate:r=!1,fresh:t=!1}={}){return t?l({adapter:i,adapterParams:e,forceRecreate:r},null,y):(c=l({adapter:i,adapterParams:e,forceRecreate:r},c,y),{setInStorage:c.setInStorage.bind(c),getFromStorage:c.getFromStorage.bind(c)})}function F({adapter:i=null,adapterParams:e=null,forceRecreate:r=!1,fresh:t=!1}={}){return t?l({adapter:i,adapterParams:e,forceRecreate:r},null,b):(h=l({adapter:i,adapterParams:e,forceRecreate:r},h,b),h)}function P({adapter:i=null,adapterParams:e=null,forceRecreate:r=!1,fresh:t=!1}={}){return t?l({adapter:i,adapterParams:e,forceRecreate:r},null,A):(p=l({adapter:i,adapterParams:e,forceRecreate:r},p,A),p)}export{P as a,k as b,F as g};
