import{a as s,l as a}from"./StorageAdapter.-Hf96jOd.js";import{j as d}from"./assign.MzTrJBn8.js";class p{async setInStorage(t,r,e={}){throw new Error("Not implemented")}async getFromStorage(t,r,e){throw new Error("Not implemented")}destroy(){if(this._unsubscribe){s("StoreAdapter - destroy - Unsubscribing from store changes."),this._unsubscribe(),this._unsubscribe=null;return}s("StoreAdapter - destroy - No unsubscribe function to call.")}}class g extends p{constructor(t){if(super(),!t)throw a("Adapter provided is not defined"),new Error("Adapter provided is not defined");this.adapter=t,this._unsubscribe=null}_getPayload(t,r){return{...t,...r,STORAGEFY_SILENT_CHANNEL_UPDATE:!0}}_registerOnDataChanged(t){s("ReactAdapter - Registering onDataChanged listener"),t&&this.adapter.onDataChanged(async r=>{try{if(r.adapterId==this.adapter.adapterId||!r.origin)return;let e;if(r.value?e=await this.adapter._decrypt(r.key,r.value):e=await this.adapter.get(r.key),typeof t.dispatch=="function"&&typeof t.getState=="function"){const n=t.getState();if(JSON.stringify(n)===JSON.stringify(e))return;t.dispatch({type:"STORAGEFY_UPDATE",payload:this._getPayload(n,e)});return}if(typeof t.getState=="function"&&typeof t.setState=="function"){const n=t.getState();if(JSON.stringify(n)===JSON.stringify(e))return;t.setState(this._getPayload(n,e));return}if(typeof t.set=="function"&&typeof t.get=="function"){const n=t.get();if(JSON.stringify(n)===JSON.stringify(e))return;t.set(this._getPayload(n,e));return}if(typeof t.update=="function"){t.update(n=>JSON.stringify(n)===JSON.stringify(e)?n:this._getPayload(n,e));return}const i=typeof t.getState=="function"?t.getState():typeof t.get=="function"?t.get():{};if(JSON.stringify(i)===JSON.stringify(e))return;typeof t.set=="function"?t.set(this._getPayload(i,e)):a("Unable to update store: No compatible update method found")}catch(e){a("Error in _registerOnDataChanged:",e)}})}async setInStorage(t,r,e={}){try{return s("ReactAdapter - setInStorage - key:",r),this._checkStore(t),e.ignoreKeys=e.ignoreKeys||[],this._unsubscribe&&this._unsubscribe(),new Promise((i,n)=>{const f=async u=>{try{if(!u)return;if(u.STORAGEFY_SILENT_CHANNEL_UPDATE)return delete u.STORAGEFY_SILENT_CHANNEL_UPDATE,i(!0);const o={...u};for(let c in o)e.ignoreKeys.includes(c)&&(o[c]=void 0);await this.adapter.set(r,o,e.timeout)}catch(o){a(o)}};if(typeof t.subscribe=="function"&&typeof t.getState=="function")f(t.getState()),this._unsubscribe=t.subscribe(()=>{f(t.getState())});else if(typeof t.subscribe=="function")this._unsubscribe=t.subscribe(f);else{n(new Error("Unsupported store type"));return}e.syncTabs&&this._registerOnDataChanged(t),i(!0)})}catch(i){throw a(i),i}}async getFromStorage(t,r){try{s("ReactAdapter - getFromStorage - key:",r),this._checkStore(t);const e=await this.adapter.get(r);if(!e)return;if(typeof t.dispatch=="function")t.dispatch({type:"SET_STATE_FROM_STORAGE",payload:e});else if(typeof t.setState=="function")t.setState(d({},e));else throw new Error("Cannot update store: setState or dispatch method not found");return!0}catch(e){throw a(e),e}}_checkStore(t){if(!t)throw a("Store provided is not defined"),new Error("Store provided is not defined");if(typeof t.getState=="function"&&typeof t.dispatch=="function"&&typeof t.subscribe=="function"||typeof t.getState=="function"&&typeof t.setState=="function"&&typeof t.subscribe=="function"||(console.log("STORE>>",t),Array.isArray(t)&&t.length===2&&typeof t[0]=="function"&&typeof t[1]=="function"))return;const r=typeof t.getState=="function"||typeof t._getState=="function",e=typeof t.setState=="function"||typeof t._setState=="function";if(!(typeof t.subscribe=="function"))throw a("Store must have a subscribe method"),new Error("Store must have a subscribe method");if(!r&&!e)throw a("Store must have either getState/setState or _getState/_setState methods"),new Error("Store must have either getState/setState or _getState/_setState methods")}}export{g as R,p as S};
